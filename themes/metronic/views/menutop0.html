<div data-component="cookie" class="hidden">@(This site uses cookies for visitor statistics. By continuing to browse the site you are agreeing to our use of cookies.) <a href="/privacy/">@(Privacy Policy)</a></div>
<div data-component="message" data-button="@(Close)"></div>

<!-- BEGIN TOP BAR -->
<div class="pre-header">
    <div class="container">
        <div class="row">
            <!-- BEGIN TOP BAR LEFT PART -->
            <div class="col-md-4 col-sm-4 additional-shop-info">
                <ul class="list-unstyled list-inline">
                    <li><a href="tel:@{CONFIG('phone')}"><i class="fa fa-phone"></i><span>@{CONFIG('phone')}</span></a></li>
                    <!-- BEGIN CURRENCIES -->
                    <li class="shop-currencies">
                        <a href="javascript:void(0);"  class="current">€</a>
                        <!--<a href="javascript:void(0);">£</a>
                        <a href="javascript:void(0);">$</a>-->
                    </li>
                    <!-- END CURRENCIES -->
                    <!-- BEGIN LANGS -->
                    <li class="langs-block">
                        <a href="javascript:void(0);" class="current">Francais</a>
                        <!--<div class="langs-block-others-wrapper"><div class="langs-block-others">
                                <a href="javascript:void(0);" >English</a>
                                <a href="javascript:void(0);">Germany</a>
                                <a href="javascript:void(0);">Turkish</a>
                            </div></div>-->
                    </li>
                    <!-- END LANGS -->
                </ul>
            </div>
            <!-- END TOP BAR LEFT PART -->
            <!-- BEGIN TOP BAR MENU -->
            <div class="col-md-8 col-sm-8 additional-nav">
                <ul class="list-unstyled list-inline pull-right">
                    @{if global.navigations.searchbar}
                    @{foreach m in global.navigations.searchbar}
                    <li><a href="@{m.url}">@{m.name}</a></li>
                    @{end}
                    @{fi}
                    @{if user}
                    <li><a href="@{sitemap_url('account')}" class="b">@(eshop:MyAccount)</a></li>
                    <li><a href="/logout/" class="font-red-flamingo">@(eshop:SignOut)</a></li>
                    <li class="dropdown dropdown-quick-sidebar-toggler">
                        <a href="javascript:;" class="dropdown-toggle font-red-flamingo" id="chaticon">
                            <i class="fa fa-comments"></i> @(Chat)
                        </a>
                    </li>
                    @{else}
                    <li><a href="@{sitemap_url('account')}" class="b">@(eshop:Login)</a></li>
                    @{fi}
                </ul>
            </div>
            <!-- END TOP BAR MENU -->
        </div>
    </div>
</div>
<!-- END TOP BAR -->

@{if user}
<!-- BEGIN QUICK SIDEBAR -->
<a href="javascript:;" class="page-quick-sidebar-toggler">
    <i class="fa fa-times"></i>
</a>
<div class="page-quick-sidebar-wrapper" data-close-on-body-click="false">
    <div class="page-quick-sidebar">
        <!--<ul class="nav nav-tabs">
            <li class="active">
                <a href="javascript:;" data-target="#quick_sidebar_tab_1" data-toggle="tab"> Chats
                    <span class="badge badge-danger">2</span>
                </a>
            </li>
        </ul>-->
        <div class="tab-content">
            <div class="tab-pane active page-quick-sidebar-chat" id="quick_sidebar_tab_1">
                <div class="page-quick-sidebar-chat-users" data-rail-color="#ddd" data-wrapper-class="page-quick-sidebar-list">
                    <h3 class="list-heading">Staff</h3>
                    <ul class="media-list list-items" data-component="repeater" data-component-path="datastaff">
                        <script type="text/html">
                            <li class="media" data-id="{{ _id }}">
                                <div class="media-status">
                                    {{if unread}}
                                    <span class="badge {{if online}}badge-success{{else}}badge-danger{{fi}}">{{unread}}</span>
                                    {{else}}
                                    {{if online}}
                                    <span class="label label-sm label-success">@(Online)</span>
                                    {{else}}
                                    <span class="label label-sm label-danger">@(Offline)</span>
                                    {{fi}}
                                    {{fi}}
                                </div>
                                <img class="media-object" src="{{if photo}}/images/u/s/{{photo}}.jpg{{else}}/img/empty.png{{fi}}" alt="{{firtname}} {{lastname}}">
                                <div class="media-body">
                                    <h4 class="media-heading">{{firstname}} {{lastname}}</h4>
                                    <div class="media-heading-sub"> {{poste}}, {{societe.name}} </div>
                                    {{if !online}}
                                    <div class="media-heading-small"> @(LastSeen) {{NewConnection | date("@{CONFIG('dateformatLong')}")}} </div>
                                    {{fi}}
                                </div>
                            </li>
                            </script>
                        </ul>
                        <h3 class="list-heading">Customers</h3>
                        <ul class="media-list list-items">
                            <li class="media">
                                <div class="media-status">
                                    <span class="badge badge-warning">2</span>
                                </div>
                                <img class="media-object" src="/assets/layouts/layout/img/avatar6.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Lara Kunis</h4>
                                    <div class="media-heading-sub"> CEO, Loop Inc </div>
                                    <div class="media-heading-small"> Last seen 03:10 AM </div>
                                </div>
                            </li>
                            <li class="media">
                                <div class="media-status">
                                    <span class="label label-sm label-success">new</span>
                                </div>
                                <img class="media-object" src="/assets/layouts/layout/img/avatar7.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Ernie Kyllonen</h4>
                                    <div class="media-heading-sub"> Project Manager,
                                        <br> SmartBizz PTL </div>
                                </div>
                            </li>
                            <li class="media">
                                <img class="media-object" src="/assets/layouts/layout/img/avatar8.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Lisa Stone</h4>
                                    <div class="media-heading-sub"> CTO, Keort Inc </div>
                                    <div class="media-heading-small"> Last seen 13:10 PM </div>
                                </div>
                            </li>
                            <li class="media">
                                <div class="media-status">
                                    <span class="badge badge-success">7</span>
                                </div>
                                <img class="media-object" src="/assets/layouts/layout/img/avatar9.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Deon Portalatin</h4>
                                    <div class="media-heading-sub"> CFO, H&D LTD </div>
                                </div>
                            </li>
                            <li class="media">
                                <img class="media-object" src="/assets/layouts/layout/img/avatar10.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Irina Savikova</h4>
                                    <div class="media-heading-sub"> CEO, Tizda Motors Inc </div>
                                </div>
                            </li>
                            <li class="media">
                                <div class="media-status">
                                    <span class="badge badge-danger">4</span>
                                </div>
                                <img class="media-object" src="/assets/layouts/layout/img/avatar11.jpg" alt="...">
                                <div class="media-body">
                                    <h4 class="media-heading">Maria Gomez</h4>
                                    <div class="media-heading-sub"> Manager, Infomatic Inc </div>
                                    <div class="media-heading-small"> Last seen 03:10 AM </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="page-quick-sidebar-item">
                        <div class="page-quick-sidebar-chat-user">
                            <div class="page-quick-sidebar-nav">
                                <a href="javascript:;" class="page-quick-sidebar-back-to-list">
                                    <i class="icon-arrow-left"></i>Back</a>
                            </div>
                            <div class="page-quick-sidebar-chat-user-messages" data-component="repeater" data-component-path="dataroom">
                                <script type="text/html">
                                    <div class="post {{author._id | inOut}}" data-id="{{ _id }}">
                                        <img class="avatar" src="{{if author.photo}}/images/u/s/{{author.photo}}.jpg{{else}}/img/empty.png{{fi}}" alt="{{author.firstname}} {{author.lastname}}" />
                                        <div class="message">
                                            <span class="arrow"></span>
                                            <a href="javascript:;" class="name">{{author.firstname}} {{author.lastname}}</a>
                                            <span class="datetime">{{createdAt | date('D MMM HH:mm')}}</span>
                                            <span class="body"> {{message}} </span>
                                        </div>
                                    </div>
                                    </script>
                                </div>
                                <div class="page-quick-sidebar-chat-user-form">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type a message here...">
                                        <div class="input-group-btn">
                                            <button type="button" class="btn green">
                                                <i class="fa fa-paperclip"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END QUICK SIDEBAR -->
        @{fi}

        @{section script}
        <script type="text/javascript">

            var socket = null;
            var userprofile;
            var datastaff = [];
            var room;

            var wrapper = $('.page-quick-sidebar-wrapper');
            var wrapperChat = wrapper.find('.page-quick-sidebar-chat');

            Tangular.register('date', function (value, format) {
                return moment(value).format(format);
            });

            Tangular.register('inOut', function (value) {
                if (value == userprofile._id)
                    return "out";
                else
                    return "in";
            });

            var addMessageChat = function (mesg) {

                var preparePost = function (dir, time, name, avatar, message) {
                    var tpl = '';
                    tpl += '<div class="post ' + dir + '">';
                    tpl += '<img class="avatar" alt="" src="' + '/img/empty' + '.png"/>';
                    tpl += '<div class="message">';
                    tpl += '<span class="arrow"></span>';
                    tpl += '<a href="#" class="name">' + name + '</a>&nbsp;';
                    tpl += '<span class="datetime">' + time + '</span>';
                    tpl += '<span class="body">';
                    tpl += message;
                    tpl += '</span>';
                    tpl += '</div>';
                    tpl += '</div>';

                    return tpl;
                };

                var chatContainer = wrapperChat.find(".page-quick-sidebar-chat-user-messages");

                var time = (mesg.createdAt ? new Date(mesg.createdAt) : new Date());
                var message;
                if (mesg.author === userprofile._id) // I'm author
                    message = preparePost('out', (time.getHours() + ':' + time.getMinutes()), userprofile.firstname + " " + userprofile.lastname, 'avatar3', mesg.message);
                else
                    message = preparePost('in', (time.getHours() + ':' + time.getMinutes()), mesg.author.firstname + " " + mesg.author.lastname, 'avatar2', mesg.message);

                message = $(message);
                chatContainer.append(message);

                chatContainer.slimScroll({
                    scrollTo: '1000000px'
                });

            };

            $(document).ready(function () {

                userprofile = JSON.parse($('#userprofile').html());
                if (userprofile && userprofile._id) {
                    scrolltotop.scrollup(); // FIX for firefox with chat TODO Find another FIX
                    connect();
                }

                wrapper.find('.page-quick-sidebar-chat-user .page-quick-sidebar-back-to-list').click(function () {
                    wrapperChat.removeClass("page-quick-sidebar-content-item-shown");
                    dataroom = [];
                    room = null;
                });

                $('.page-quick-sidebar-chat-users').on('click', '.media', function (e) {
                    wrapperChat.addClass("page-quick-sidebar-content-item-shown");

                    room = $(this).attr('data-id');

                    dataroom = [];

                    if (!room)
                        return;

                    AJAX('GET /chat/room/' + room, function (response) {

                        for (var i = 0, length = response.length; i < length; i++) {
                            var item = response[i];
                            dataroom.push(item);
                        }

                        UPDATE('dataroom');

                        var idx = null;
                        for (var i = 0, len = datastaff.length; i < len; i++)
                            if (datastaff[i]._id == room) {
                                idx = i;
                                break;
                            }

                        datastaff[i].unread = 0;
                        UPDATE('datastaff');

                    });


                });


                var handleChatMessagePost = function (e) {
                    e.preventDefault();

                    var chatContainer = wrapperChat.find(".page-quick-sidebar-chat-user-messages");
                    var input = wrapperChat.find('.page-quick-sidebar-chat-user-form .form-control');

                    var text = input.val();
                    if (text.length === 0) {
                        return;
                    }

                    // send to websocket
                    var mesg = {
                        type: "chat",
                        message: {
                            members: [room],
                            message: text,
                            author: userprofile._id
                        }
                    };

                    send(mesg);

                    addMessageChat(mesg.message);

                    input.val("");
                };

                wrapperChat.find('.page-quick-sidebar-chat-user-form .btn').click(handleChatMessagePost);
                wrapperChat.find('.page-quick-sidebar-chat-user-form .form-control').keypress(function (e) {
                    if (e.which == 13) {
                        handleChatMessagePost(e);
                        return false;
                    }
                });




                //wrapper.find('.page-quick-sidebar-chat-users .media-list > .media').click(function () {
                //    wrapperChat.addClass("page-quick-sidebar-content-item-shown");
                //});




                /*$('button').bind('click', function () {
                 
                 if (this.name === 'rename') {
                 var value = $('input[name="username"]').val();
                 
                 if (value.length > 0)
                 socket.send(encodeURIComponent(JSON.stringify({username: value})));
                 
                 return;
                 }
                 
                 if (this.name === 'send') {
                 console.log('send');
                 send();
                 return;
                 }
                 
                 if (this.name === 'open') {
                 connect();
                 return;
                 }
                 
                 console.log('disconnect');
                 disconnect();
                 });*/
            });

            function connect() {

                if (socket !== null)
                    return;

                socket = new ReconnectingWebSocket('ws://' + window.location.hostname + ':' + window.location.port + '/chat');

                socket.onopen = function (e) {
                    console.log('open');
                    if (socket !== null)
                        socket.send(encodeURIComponent(JSON.stringify({type: 'change', message: userprofile._id})));
                };

                socket.onmessage = function (e) {
                    //var el = $('#output');
                    var m = JSON.parse(decodeURIComponent(e.data));
                    console.log(m);
                    //el.val(m + '\n' + el.val());

                    if (m.type === 'users') {

                        AJAX('GET /chat/users/', {id: m.message.id}, function (response) {

                            datastaff = [];

                            for (var i = 0, length = response.length; i < length; i++) {
                                var item = response[i];
                                datastaff.push(item);
                            }

                            UPDATE('datastaff');
                        });
                    }


                    if (m.type === 'chat') {
                        if (room === m.message.author._id) {
                            addMessageChat(m.message);
                            if (socket !== null)
                                socket.send(encodeURIComponent(JSON.stringify({type: 'read', message: m.message._id, user: userprofile._id})));
                        } else {
                            // find datastaff index
                            var idx = null;
                            for (var i = 0, len = datastaff.length; i < len; i++)
                                if (datastaff[i]._id == m.message.author._id) {
                                    idx = i;
                                    break;
                                }

                            if (idx !== null) {
                                datastaff[i].unread++;
                                UPDATE('datastaff');
                            }

                        }


                    }

                    if (m.type === 'online') {
                        // it's me !
                        if (m.message._id === userprofile._id) {
                            if (m.online)
                                $('#chaticon').removeClass("font-red-flamingo").addClass('font-green');
                            else
                                $('#chaticon').addClass("font-red-flamingo").removeClass('font-green');

                            return;
                        }


                        // find datastaff index
                        var idx = null;
                        for (var i = 0, len = datastaff.length; i < len; i++)
                            if (datastaff[i]._id == m.message._id) {
                                idx = i;
                                break;
                            }

                        if (m.online == true)
                            // already known
                            if (idx !== null)
                                datastaff[idx].online = true;
                            else {
                                datastaff.push(m.message);
                                datastaff[datastaff.length - 1].online = true;
                            }
                        else if (idx !== null) {
                            datastaff[idx].online = false;
                            if (!datastaff[idx].count) {
                                datastaff.splice(idx, 1);
                            }
                        }

                        UPDATE('datastaff');
                        //if (socket !== null)
                        //    socket.send(encodeURIComponent(JSON.stringify({type: 'refresh'})));

                    }


                };

                socket.onclose = function (e) {
                    $('#chaticon').addClass("font-red-flamingo").removeClass('font-green');
                    datastaff = [];
                    UPDATE('datastaff');
                };
            }

            function send(msg) {
                if (socket !== null && msg.message.message.length > 0)
                    socket.send(encodeURIComponent(JSON.stringify(msg)));
            }

            function disconnect() {

                if (socket === null)
                    return;

                $('button[name="close"],button[name="send"],button[name="rename"]').attr('disabled', true);
                $('button[name="open"]').attr('disabled', false);

                socket.close();
                socket = null;
            }

        </script>
        @{end}